<html>
<head>
    <title></title>
    <meta charset="utf-8">
    <script type="text/javascript" src="../../qtek/thirdparty/require.js"></script>
    <script type="text/javascript" src="./js/config.js"></script>
    <script type="text/javascript" src="../lib/polyk.js"></script>
</head>
<body style="margin:0px">
    <canvas id="main"></canvas>
    <script type="text/javascript">
        require(['qtek/qtek',
                'qtek-2d'], function(qtek, qtek2d){
            var contour = [242.673,35.84,220.25,39.343,189.887,51.956,154.385,81.619,165.82899999999998,74.378,181.712,59.663,181.47799999999998,62.7,195.72499999999997,52.657000000000004,195.02499999999998,55.226,223.51999999999998,42.146,221.18399999999997,45.882999999999996,227.49049999999997,44.53999999999999,233.65099999999995,43.48887499999999,239.81149999999997,42.437749999999994,245.82599999999996,41.6785,245.24199999999996,42.846,267.19699999999995,47.985,263.92799999999994,48.217999999999996,264.62799999999993,53.824,260.6569999999999,58.961999999999996,254.35199999999992,54.291,245.70899999999992,53.357,242.67299999999992,54.291,237.30099999999993,49.62,220.48499999999993,48.452999999999996,184.74899999999994,63.16799999999999,182.41299999999993,63.867999999999995,175.40599999999992,71.34299999999999,168.63299999999992,76.481,165.1299999999999,78.11599999999999,148.7789999999999,93.29799999999999,147.7862499999999,94.81625,146.6768749999999,96.39287499999999,145.5674999999999,97.96949999999998,144.3414999999999,99.60449999999999,143.87499999999991,99.838,147.9039999999999,97.327125,153.68499999999992,93.065,170.0349999999999,81.386,176.34099999999992,80.452,182.41299999999993,75.314,199.22999999999993,64.57,204.13499999999993,64.57,209.85749999999996,66.58449999999999,217.68299999999994,62.46699999999999,224.45599999999993,60.364999999999995,230.99499999999995,61.76699999999999,233.79799999999994,56.16099999999999,235.66699999999994,54.05899999999999,236.83499999999995,58.496999999999986,246.41099999999994,60.36499999999999,251.08199999999994,60.13199999999999,248.74699999999996,62.93399999999999,243.60799999999995,67.37199999999999,229.82799999999995,67.60499999999999,196.19399999999996,77.18099999999998,150.64799999999997,101.47199999999998,143.17299999999997,111.74899999999998,136.86799999999997,113.15099999999998,123.08699999999996,122.72699999999998,134.53199999999995,115.95399999999998,145.04299999999995,115.95399999999998,149.71399999999994,113.15099999999998,145.27599999999995,117.35499999999998,142.93999999999994,132.53699999999998,142.23999999999995,138.60999999999999,141.30499999999995,140.47799999999998,132.19599999999994,158.22899999999998,132.95487499999993,166.49175,134.06399999999994,173.178,134.00624999999994,173.06125,134.21074999999993,172.85674999999998,134.41524999999993,172.65224999999998,135.11599999999993,172.7105,137.33499999999992,174.112,141.4809999999999,176.68124999999998,142.9699999999999,177.907375,144.45899999999992,179.1335,145.50999999999993,180.418,145.97699999999992,182.053,146.44449999999992,183.688,145.86074999999994,182.11124999999998,145.13087499999995,179.863,144.48398478770335,177.87036986498268,143.722308632008,175.35025462480016,143.47601234226963,174.07122624157464,143.44441680267488,173.90714909705918,143.4213025794297,173.7634958203477,143.40799999999993,173.644,138.26999999999992,163.13400000000001,139.20399999999992,160.33100000000002,139.49599999999992,160.62275000000002,139.90487499999992,161.11900000000003,140.3137499999999,161.61525000000003,140.83949999999993,162.31600000000003,141.30699999999993,163.13400000000001,140.60599999999994,162.43300000000002,141.30699999999993,158.229,142.24199999999993,152.157,143.87599999999992,148.419,145.5099999999999,144.681,148.3139999999999,139.31,148.78099999999992,131.602,150.41699999999992,134.639,154.38799999999992,137.675,151.11699999999993,134.639,153.68699999999993,132.07000000000002,152.51899999999992,125.53000000000002,154.62199999999993,122.49400000000003,162.79699999999994,112.68400000000003,164.66499999999994,111.51600000000003,164.89799999999994,110.81500000000004,165.13199999999995,107.77900000000004,160.45999999999995,109.64700000000003,156.95599999999996,109.64700000000003,148.08099999999996,111.98300000000003,152.75199999999995,107.07800000000003,157.42399999999995,102.17300000000003,169.10199999999995,95.86700000000003,173.53999999999996,96.10000000000004,174.47399999999996,97.96900000000004,187.55399999999997,95.16600000000004,186.15299999999996,96.10000000000004,185.91999999999996,95.86700000000003,190.82499999999996,95.39900000000004,195.72899999999996,94.93200000000004,204.13699999999997,94.46500000000005,205.77299999999997,92.36300000000004,209.74299999999997,91.19500000000005,209.27599999999998,92.83000000000004,208.576,96.80000000000004,214.415,90.02700000000004,213.715,92.59600000000005,213.014,95.16500000000005,201.803,108.47900000000004,213.949,98.90200000000004,218.15300000000002,95.39900000000004,222.591,96.10000000000004,222.824,94.23200000000004,228.196,87.45800000000004,229.598,87.69200000000004,233.335,84.65500000000003,233.102,87.69200000000004,241.744,97.03500000000004,245.481,94.93300000000004,247.11599999999999,96.56800000000004,253.65599999999998,73.44500000000004,282.852,61.06600000000004,333.769,57.09500000000004,313.91700000000003,49.15400000000004];
            // contour = contour.slice(0, 64);
            if (!isCCW()) {
                contour = PolyK.Reverse(contour);
            }
            // Remove duplicate
            for (var i = 0; i < contour.length;) {
                x0 = contour[i], y0 = contour[i + 1];
                x1 = contour[(i + 2) % contour.length], y1 = contour[(i + 3) % contour.length];

                if (Math.abs(x0 - x1) < 0.1 && Math.abs(y0 - y1) < 0.1) {
                    contour.splice(i, 2);
                } else {
                    i += 2;
                }
            }

            var triangulation = new qtek2d.context.tool.Triangulation2();
            var start = performance.now();
            for (var i = 0; i < 1; i++) {
                triangulation.triangulate(contour);
            }
            var end = performance.now();
            console.log(end - start);

            var canvas = document.getElementById('main');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            var ctx = canvas.getContext('2d');
            var triangles = triangulation.triangles;
            ctx.lineWidth = 0.3;
            ctx.scale(3, 3);

            var gridWidth = triangulation._gridWidth;
            var gridHeight = triangulation._gridHeight;
            var nGrid = triangulation._gridNumber;
            var bb = triangulation._boundingBox;
            var grids = triangulation._grids;
            for (var i = 0; i < nGrid; i++) {
                var y0 = i * gridHeight + bb[0][1];
                var y1 = (i + 1) * gridHeight + bb[0][1];
                for (var j = 0; j < nGrid; j++) {
                    // Draw debug grids
                    ctx.fillStyle = 'rgb(' + [Math.round(i / nGrid * 255), Math.round(j / nGrid * 255), 0].join(',') + ')';
                    ctx.globalAlpha = 0.5;
                    var x0 = j * gridWidth + bb[0][0];
                    var x1 = (j + 1) * gridWidth + bb[0][0];

                    ctx.fillRect(x0, y0, x1 - x0, y1 - y0);
                    // ctx.strokeRect(x0, y0, x1 - x0, y1 - y0);

                    // Draw points in grid
                    var gridIdx = i * nGrid + j;
                    var gridPoints = grids[gridIdx];
                    for (var k = 0; k < gridPoints.length; k++) {
                        var idx = gridPoints[k];
                        var xi = contour[idx * 2];
                        var yi = contour[idx * 2 + 1];

                        ctx.globalAlpha = 0.5;
                        ctx.beginPath();
                        ctx.arc(xi, yi, 1, 0, 2 * Math.PI);
                        ctx.fill();
                        // ctx.stroke();
                    }
                }
            }


            // Draw Debug Triangles
            ctx.globalAlpha = 1.0;
            for (var i = 0; i < triangles.length / 3; i++) {
                ctx.beginPath();
                var p0 = triangles[i * 3];
                var p1 = triangles[i * 3 + 1];
                var p2 = triangles[i * 3 + 2];
                ctx.strokeStyle = 'rgb(' + [Math.round(i * 255 / triangles.length), 0, 0].join(',') + ')';
                ctx.moveTo(contour[p0 * 2], contour[p0 * 2 + 1]);
                ctx.lineTo(contour[p1 * 2], contour[p1 * 2 + 1]);
                ctx.lineTo(contour[p2 * 2], contour[p2 * 2 + 1]);
                ctx.closePath();
                ctx.stroke();
            }


            function isCCW() {
                // Signed polygon area
                var n = contour.length / 2;
                if (n < 3) {
                    return false;
                }
                var area = 0;
                for (var i = (n - 1) * 2, j = 0; j < n * 2;) {
                    var x0 = contour[i];
                    var y0 = contour[i + 1];
                    var x1 = contour[j];
                    var y1 = contour[j + 1];
                    i = j;
                    j += 2;
                    area += x0 * y1 - x1 * y0;
                }

                return area < 0;
            }

        });
    </script>
</body>
</html>